<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INTERCEPTION - CONFIDENTIAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Safe Area Variables for notch/home bar */
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #050505;
            background-image:
                linear-gradient(rgba(0, 255, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            color: #e0e0e0;
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height specifically for mobile browsers */
            overflow: hidden;
            padding-top: var(--sat);
            padding-bottom: var(--sab);
        }

        /* Vignette & Scanline */
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 50%, black 150%);
            pointer-events: none;
            z-index: 10;
        }

        .crt-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 5s linear infinite;
            z-index: 9;
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                top: -10%;
            }

            100% {
                top: 110%;
            }
        }

        /* Glass / Tech Panel */
        .glass {
            background: rgba(10, 20, 10, 0.7);
            border: 1px solid #333;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            position: relative;
        }

        .glass::before {
            content: "";
            position: absolute;
            top: -1px;
            left: -1px;
            width: 10px;
            height: 10px;
            border-top: 2px solid #555;
            border-left: 2px solid #555;
        }

        .glass::after {
            content: "";
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid #555;
            border-right: 2px solid #555;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }

        .text-neon-green {
            color: #00ff41;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }

        .border-neon-green {
            border-color: #00ff41;
        }

        .bg-neon-green {
            background-color: #00ff41;
        }

        .text-neon-red {
            color: #ff3333;
            text-shadow: 0 0 5px rgba(255, 51, 51, 0.5);
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4 relative">

    <div class="crt-line"></div>

    <div id="toast"
        class="fixed top-12 left-1/2 transform -translate-x-1/2 z-50 bg-black border border-red-500 text-red-500 px-6 py-3 shadow-[0_0_15px_rgba(255,0,0,0.5)] text-sm font-bold hidden transition-all duration-300 uppercase tracking-widest text-center w-max max-w-[90%]">
        Erreur
    </div>

    <!-- MENU SCREEN -->
    <div id="screen-menu" class="w-full max-w-md flex flex-col gap-6 fade-in z-20 overflow-y-auto no-scrollbar py-4">
        <h1 class="text-5xl font-bold text-center text-gray-200 tracking-[0.2em] mb-4 drop-shadow-lg mt-8">
            INTER<span class="text-neon-red">CEPTION</span>
        </h1>

        <div class="glass p-6 flex flex-col gap-4">
            <label class="text-xs text-neon-green font-bold uppercase tracking-widest mb-1">> IDENTIFIANT_AGENT</label>
            <input type="text" id="username" placeholder="NOM DE CODE..."
                class="w-full bg-black/50 border border-gray-600 text-white px-4 py-4 text-lg font-bold placeholder-gray-700 focus:bg-black transition-all font-mono">
        </div>

        <div class="glass p-6 flex flex-col gap-4 mt-2">
            <label class="text-xs text-neon-green font-bold uppercase tracking-widest mb-1">> ACCES_MISSION</label>
            <div class="flex gap-2">
                <input type="text" id="join-code" placeholder="CODE" maxlength="4"
                    class="w-2/3 bg-black/50 border border-gray-600 text-white px-4 py-4 text-lg text-center font-bold uppercase tracking-[0.2em] placeholder-gray-700 focus:bg-black transition-all font-mono">
                <button onclick="joinGame()"
                    class="w-1/3 bg-gray-800 hover:bg-gray-700 border border-gray-500 text-white font-bold active:scale-95 transition-all text-sm tracking-widest hover:border-neon-green hover:text-neon-green">
                    JOIN
                </button>
            </div>
        </div>

        <div class="relative flex py-2 items-center opacity-50">
            <div class="flex-grow border-t border-gray-800"></div>
            <span class="flex-shrink mx-4 text-gray-600 text-xs tracking-widest">OU</span>
            <div class="flex-grow border-t border-gray-800"></div>
        </div>

        <button onclick="createGame()"
            class="w-full bg-gradient-to-r from-gray-900 to-black hover:from-black hover:to-gray-900 border border-neon-red text-neon-red font-bold py-5 text-xl shadow-[0_0_10px_rgba(255,51,51,0.2)] active:scale-95 transition-all tracking-widest mb-8">
            INITIER_PROTOCOLE
        </button>
    </div>

    <!-- LOBBY SCREEN -->
    <div id="screen-lobby" class="w-full max-w-md h-full flex flex-col hidden z-20 relative pt-2">

        <!-- Top Bar -->
        <div class="flex justify-between items-end mb-4 pt-2 border-b border-gray-800 pb-2">
            <button onclick="leaveGame()"
                class="text-gray-500 hover:text-red-500 text-xs font-bold tracking-widest transition-colors p-2">
                < ABORT </button>
                    <div class="text-right">
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest">Fr√©quence S√©curis√©e</div>
                        <div class="flex items-center justify-end gap-2">
                            <span id="lobby-code-display"
                                class="text-neon-green font-bold text-3xl tracking-[0.1em] select-all cursor-pointer hover:bg-green-900/30 px-2 rounded">????</span>
                        </div>
                    </div>
        </div>

        <!-- Status Box -->
        <div id="game-status-container"
            class="glass p-6 text-center mb-6 flex flex-col items-center justify-center min-h-[120px] border-l-4 border-l-gray-500 shrink-0">
            <div id="status-icon" class="text-3xl mb-2 opacity-80"></div>
            <h2 id="game-status-text" class="text-xl font-bold text-white uppercase tracking-widest">En attente...</h2>
            <p id="game-status-sub" class="text-gray-500 text-xs mt-1 font-mono">Awaiting admin command...</p>
        </div>

        <!-- Admin Controls -->
        <div id="admin-controls" class="hidden flex flex-col gap-3 mb-6 shrink-0">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="shareCode()"
                    class="bg-gray-900 hover:bg-gray-800 border border-gray-700 text-gray-300 p-3 font-bold text-xs uppercase tracking-wider transition-all hover:border-white">
                    ‚úâÔ∏è TRANSMETTRE
                </button>
                <button onclick="deleteLobby()"
                    class="bg-black hover:bg-red-900/20 border border-red-900/50 text-red-500 p-3 font-bold text-xs uppercase tracking-wider transition-all hover:border-red-500 hover:shadow-[0_0_10px_rgba(255,0,0,0.3)]">
                    ‚úñ DETRUIRE
                </button>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-2">
                <button onclick="updateGameState('playing')"
                    class="col-span-1 bg-green-900/20 hover:bg-green-900/40 border border-green-700 text-green-400 p-3 font-bold shadow-[0_0_10px_rgba(0,255,0,0.1)] active:scale-95 transition-all uppercase text-xs">
                    ‚ñ∂ LAUNCH
                </button>
                <button onclick="updateGameState('paused')"
                    class="col-span-1 bg-yellow-900/20 hover:bg-yellow-900/40 border border-yellow-700 text-yellow-500 p-3 font-bold active:scale-95 transition-all uppercase text-xs">
                    ‚è∏ FREEZE
                </button>
                <button onclick="updateGameState('finished')"
                    class="col-span-1 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-400 p-3 font-bold active:scale-95 transition-all uppercase text-xs">
                    üèÅ END
                </button>
            </div>
        </div>

        <!-- Players List -->
        <div class="flex-1 glass flex flex-col overflow-hidden relative mb-4">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gray-700 to-transparent">
            </div>

            <h3
                class="p-4 text-xs font-bold text-gray-500 uppercase tracking-widest flex justify-between items-center border-b border-gray-800 shrink-0">
                <span>AGENTS ACTIFS</span>
                <span id="player-count" class="text-neon-green font-mono text-lg">0</span>
            </h3>

            <div id="players-list" class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-2">
                <!-- Players will be injected here -->
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="w-full max-w-md h-full flex flex-col hidden z-20 relative pt-4 pb-8">
        <!-- Header Info -->
        <div class="flex justify-between items-center mb-4 px-2 border-b border-gray-800 pb-2">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest">MISSION EN COURS</span>
                <span id="game-timer" class="text-3xl text-white font-mono font-bold">03:00</span>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest">GROUPE</div>
                <span id="group-id-display" class="text-neon-green font-bold text-xl tracking-widest">ALPHA</span>
            </div>
        </div>

        <!-- Role Card -->
        <div id="role-card"
            class="glass p-6 rounded-2xl mb-6 flex flex-col items-center justify-center text-center border-t-4 transition-all duration-500 min-h-[200px]">
            <div id="role-icon" class="text-5xl mb-4"></div>
            <h2 id="role-title" class="text-2xl font-bold text-white uppercase tracking-widest mb-1"></h2>
            <p id="role-desc" class="text-gray-400 text-xs font-mono mb-4 px-4"></p>

            <!-- SECRET SECTION (Informant only) -->
            <div id="secret-container"
                class="hidden bg-black/50 p-4 rounded border border-gray-700 w-full animate-pulse-slow">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">CIBLE A TRANSMETTRE</div>
                <div id="secret-word" class="text-3xl font-bold text-neon-green tracking-widest uppercase">???</div>
                <div id="secret-theme" class="text-xs text-gray-400 mt-2 font-mono">TH√àME: <span
                        class="text-white">...</span></div>
            </div>

            <!-- GUESS SECTION (Target & Interceptor) -->
            <div id="guess-container" class="hidden w-full flex flex-col gap-3">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest text-left">TH√àME: <span
                        id="public-theme" class="text-white font-bold ml-1">???</span></div>
                <input type="text" id="guess-input" placeholder="ENTRER LE CODE..." autocomplete="off"
                    class="w-full bg-black/80 border border-gray-600 text-white px-4 py-3 text-center text-lg font-bold uppercase tracking-widest placeholder-gray-700 focus:border-neon-green focus:bg-black transition-all">
                <button onclick="submitGuess()" id="btn-submit"
                    class="w-full bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 font-bold py-3 uppercase tracking-widest text-xs active:scale-95 transition-all">
                    CONFIRMER L'INTERCEPTION
                </button>
            </div>
        </div>

        <!-- Game Status / Feedback -->
        <div id="game-feedback" class="glass p-4 text-center hidden mb-4">
            <span class="text-neon-green font-bold uppercase tracking-widest animate-pulse">TRANSMISSION EN
                COURS...</span>
        </div>

        <!-- Admin Force Stop -->
        <div id="admin-game-controls" class="mt-auto hidden">
            <button onclick="stopRound()"
                class="w-full border border-red-900/50 text-red-900 hover:bg-red-900/10 hover:text-red-500 py-3 text-xs font-bold uppercase tracking-widest transition-all">
                ‚ö†Ô∏è ARR√äT D'URGENCE
            </button>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="screen-results" class="w-full max-w-md h-full flex flex-col hidden z-20 relative pt-10">
        <h1 class="text-4xl font-bold text-center text-white tracking-[0.2em] mb-2">RAPPORT</h1>
        <div class="h-1 w-20 bg-gray-800 mx-auto mb-8"></div>

        <div id="results-container" class="flex-1 overflow-y-auto no-scrollbar space-y-4 px-2">
            <!-- Results injected here -->
        </div>

        <div id="admin-results-controls" class="mt-4 hidden pb-8">
            <button onclick="startNewRound()"
                class="w-full bg-neon-green text-black font-bold py-4 text-lg shadow-[0_0_15px_rgba(0,255,65,0.4)] active:scale-95 transition-all tracking-widest uppercase">
                NOUVELLE MISSION
            </button>
        </div>
        <div id="waiting-next-round" class="mt-4 pb-8 text-center hidden">
            <p class="text-gray-500 text-xs font-mono animate-pulse">ATTENTE DU COMMANDANT...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCiarvgeK3eS8S1SxBj3SMW0L4AzsBkig8",
            authDomain: "interception-e9a6d.firebaseapp.com",
            projectId: "interception-e9a6d",
            storageBucket: "interception-e9a6d.firebasestorage.app",
            messagingSenderId: "533782599002",
            appId: "1:533782599002:web:8ec56b56a05bc0f24f4f63"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATA ---
        const WORDS_DB = [
            { t: "ANIMAUX", w: ["LION", "AIGLE", "REQUIN", "ELEPHANT", "GIRAFE", "LOUP", "OURS", "TIGRE", "SERPENT", "PANDA"] },
            { t: "METIERS", w: ["POMPIER", "ACTEUR", "MEDECIN", "AVOCAT", "PILOTE", "CHEF", "MA√áON", "POLICIER", "JUGE", "PLOMBIER"] },
            { t: "COULEURS", w: ["ROUGE", "BLEU", "VERT", "JAUNE", "VIOLET", "ORANGE", "NOIR", "BLANC", "ROSE", "INDIGO"] },
            { t: "OBJETS", w: ["LAMPE", "STYLO", "TELEPHONE", "LIVRE", "MONTRE", "REGLE", "LUNETTES", "CLE", "ALLUMETTE", "MIROIR"] },
            { t: "NOURRITURE", w: ["PIZZA", "SUSHI", "BURGER", "PATES", "SALADE", "POMME", "BANANE", "CHOCOLAT", "GLACE", "FROMAGE"] },
            { t: "LIEUX", w: ["ECOLE", "PLAGE", "MONTAGNE", "FORET", "HOPITAL", "AEROPORT", "GARA", "HOTEL", "CINEMA", "PARC"] }
        ];

        // --- STATE ---
        let currentUser = { id: null, name: null, isAdmin: false };
        let currentLobbyCode = null;
        let lobbyData = null;
        let timerInterval = null;

        // --- DOM ---
        const screens = {
            menu: document.getElementById('screen-menu'),
            lobby: document.getElementById('screen-lobby'),
            game: document.getElementById('screen-game'),
            results: document.getElementById('screen-results')
        };
        const inputs = {
            username: document.getElementById('username'),
            joinCode: document.getElementById('join-code'),
            guess: document.getElementById('guess-input')
        };

        // --- HELPERS ---
        function saveSession(user, code) { localStorage.setItem('interception_session', JSON.stringify({ user, code, timestamp: Date.now() })); }
        function clearSession() { localStorage.removeItem('interception_session'); }
        function restoreSession() {
            const raw = localStorage.getItem('interception_session');
            if (raw) {
                try {
                    const s = JSON.parse(raw);
                    if (s.user && s.code) {
                        currentUser = s.user;
                        currentLobbyCode = s.code;
                        inputs.username.value = s.user.name;
                        inputs.joinCode.value = s.code;
                        setupLobbyListener(s.code);
                        return true;
                    }
                } catch (e) { clearSession(); }
            }
            return false;
        }

        function generateCode() { let c = "ABCDEFGHJKLMNPQRSTUVWXYZ", r = ""; for (let i = 0; i < 4; i++)r += c.charAt(Math.floor(Math.random() * c.length)); return r; }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function showToast(msg, type = 'error') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed top-12 left-1/2 transform -translate-x-1/2 z-50 bg-black border ${type === 'success' ? 'border-green-500 text-green-500' : 'border-red-500 text-red-500'} px-6 py-3 shadow-lg text-sm font-bold w-max max-w-[90%] text-center uppercase tracking-widest`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        function switchScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
            screens[name].classList.add('fade-in');
        }

        // --- LOGIC ---

        function pickWord() {
            const cat = WORDS_DB[Math.floor(Math.random() * WORDS_DB.length)];
            const word = cat.w[Math.floor(Math.random() * cat.w.length)];
            return { word, theme: cat.t };
        }

        function distributeRoles(players) {
            const shuffled = [...players].sort(() => Math.random() - 0.5);
            const count = shuffled.length;
            const groups = [];

            if (count <= 5) {
                let group = { players: [], wordObj: pickWord(), status: 'active', id: 'ALPHA' };
                let roles = [];
                if (count === 3) roles = ['informant', 'target', 'interceptor'];
                else if (count === 4) roles = ['informant', 'target', 'interceptor', 'interceptor'];
                else if (count === 5) roles = ['informant', 'target', 'target', 'interceptor', 'interceptor'];

                shuffled.forEach((p, i) => { group.players.push({ id: p.id, name: p.name, role: roles[i] }); });
                groups.push(group);
            } else {
                let splits = [];
                if (count === 6) splits = [3, 3];
                else if (count === 7) splits = [3, 4];
                else if (count === 8) splits = [4, 4];
                else {
                    let remain = count;
                    while (remain > 0) {
                        if (remain >= 4) { splits.push(4); remain -= 4; }
                        else { splits.push(remain); remain = 0; }
                    }
                }

                let pIndex = 0;
                const groupNames = ['ALPHA', 'BRAVO', 'CHARLIE', 'DELTA'];
                splits.forEach((size, idx) => {
                    let group = { players: [], wordObj: pickWord(), status: 'active', id: groupNames[idx] || `G-${idx + 1}` };
                    let chunk = shuffled.slice(pIndex, pIndex + size);
                    pIndex += size;

                    let roles = [];
                    if (size === 3) roles = ['informant', 'target', 'interceptor'];
                    else if (size === 4) roles = ['informant', 'target', 'interceptor', 'interceptor'];
                    else {
                        roles.push('informant');
                        if (size > 1) roles.push('target');
                        while (roles.length < size) roles.push('interceptor');
                    }
                    chunk.forEach((p, i) => { group.players.push({ id: p.id, name: p.name, role: roles[i] }); });
                    groups.push(group);
                });
            }
            return groups;
        }

        // --- EVENTS ---

        window.createGame = async () => {
            const name = inputs.username.value.trim().toUpperCase();
            if (!name) return showToast("IDENTIFIANT REQUIS");
            const code = generateCode();
            const uid = generateId();
            currentUser = { id: uid, name, isAdmin: true };
            currentLobbyCode = code;
            try {
                await setDoc(doc(db, "lobbies", code), {
                    adminId: uid,
                    state: "waiting",
                    players: [{ id: uid, name, joinedAt: Date.now() }],
                    round: null
                });
                saveSession(currentUser, code);
                setupLobbyListener(code);
            } catch (e) { showToast("ERREUR SYSTEME"); }
        };

        window.joinGame = async () => {
            const name = inputs.username.value.trim().toUpperCase();
            const code = inputs.joinCode.value.trim().toUpperCase();
            if (!name || code.length !== 4) return showToast("DONNEES INVALIDES");
            const uid = generateId();
            currentUser = { id: uid, name, isAdmin: false };
            currentLobbyCode = code;
            const ref = doc(db, "lobbies", code);
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return showToast("FREQUENCE INCONNUE");
                await updateDoc(ref, { players: arrayUnion({ id: uid, name, joinedAt: Date.now() }) });
                saveSession(currentUser, code);
                setupLobbyListener(code);
            } catch (e) { showToast("ERREUR CONNEXION"); }
        };

        window.startRound = async () => {
            if (!currentUser.isAdmin) return;
            if (lobbyData.players.length < 3) return showToast("MINIMUM 3 AGENTS REQUIS", "error");
            const groups = distributeRoles(lobbyData.players);
            await updateDoc(doc(db, "lobbies", currentLobbyCode), {
                state: 'playing',
                round: { startTime: Date.now(), duration: 180, groups: groups }
            });
        };

        window.stopRound = async () => {
            if (!currentUser.isAdmin) return;
            if (!confirm("ARRETER LA MISSION EN COURS ?")) return;
            await updateDoc(doc(db, "lobbies", currentLobbyCode), { state: 'finished' });
        };

        window.startNewRound = async () => {
            if (!currentUser.isAdmin) return;
            await updateDoc(doc(db, "lobbies", currentLobbyCode), { state: 'waiting', round: null });
        };

        window.submitGuess = async () => {
            const guess = inputs.guess.value.trim().toUpperCase();
            if (!guess) return;
            const groupIdx = lobbyData.round.groups.findIndex(g => g.players.find(p => p.id === currentUser.id));
            if (groupIdx === -1) return;
            const group = lobbyData.round.groups[groupIdx];
            const myRoleData = group.players.find(p => p.id === currentUser.id);

            const normalizedGuess = guess.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const normalizedTarget = group.wordObj.word.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (normalizedGuess === normalizedTarget) {
                let resultStatus = myRoleData.role === 'target' ? "target_won" : "interceptor_won";
                const newGroups = [...lobbyData.round.groups];
                newGroups[groupIdx].status = resultStatus;
                newGroups[groupIdx].winnerId = currentUser.id;
                await updateDoc(doc(db, "lobbies", currentLobbyCode), { "round.groups": newGroups });
            } else {
                showToast("CODE INCORRECT", "error");
                inputs.guess.value = "";
                inputs.guess.classList.add('animate-shake');
            }
        };

        window.updateGameState = async (newState) => {
            if (!currentUser.isAdmin) return;
            await updateDoc(doc(db, "lobbies", currentLobbyCode), { state: newState });
        };

        // --- VIEW UPDATES ---

        function updateTimer() {
            if (!lobbyData || lobbyData.state !== 'playing' || !lobbyData.round) return;
            const elapsed = Math.floor((Date.now() - lobbyData.round.startTime) / 1000);
            const remaining = Math.max(0, lobbyData.round.duration - elapsed);
            const m = Math.floor(remaining / 60).toString().padStart(2, '0');
            const s = (remaining % 60).toString().padStart(2, '0');
            const el = document.getElementById('game-timer');
            if (el) {
                el.innerText = `${m}:${s}`;
                if (remaining < 30) el.classList.add('text-red-500'); else el.classList.remove('text-red-500');
            }
        }

        function renderGameView(round) {
            let myGroup = null, myPlayer = null;
            if (!round || !round.groups) return;
            round.groups.forEach(g => { const p = g.players.find(x => x.id === currentUser.id); if (p) { myGroup = g; myPlayer = p; } });
            if (!myPlayer) { document.getElementById('role-title').innerText = "OBSERVATEUR"; return; }

            document.getElementById('group-id-display').innerText = myGroup.id;
            const rTitle = document.getElementById('role-title');
            const rDesc = document.getElementById('role-desc');
            const rIcon = document.getElementById('role-icon');
            const boxSecret = document.getElementById('secret-container');
            const boxGuess = document.getElementById('guess-container');
            const inputLabel = document.getElementById('public-theme');

            document.getElementById('role-card').className = "glass p-6 rounded-2xl mb-6 flex flex-col items-center justify-center text-center border-t-4 transition-all duration-500 min-h-[200px]";

            if (myPlayer.role === 'informant') {
                rTitle.innerText = "INFORMATEUR";
                rTitle.className = "text-2xl font-bold text-blue-400 uppercase tracking-widest mb-1";
                rDesc.innerText = "Transmettez le code. √âvitez les interceptions.";
                rIcon.innerText = "üì°";
                document.getElementById('role-card').classList.add('border-blue-500');
                boxSecret.classList.remove('hidden');
                boxGuess.classList.add('hidden');
                document.getElementById('secret-word').innerText = myGroup.wordObj.word;
                document.getElementById('secret-theme').innerHTML = `TH√àME: <span class="text-white">${myGroup.wordObj.theme}</span>`;
            } else if (myPlayer.role === 'target') {
                rTitle.innerText = "CIBLE";
                rTitle.className = "text-2xl font-bold text-green-400 uppercase tracking-widest mb-1";
                rDesc.innerText = "Recevez le code de l'Informateur.";
                rIcon.innerText = "üéØ";
                document.getElementById('role-card').classList.add('border-green-500');
                boxSecret.classList.add('hidden');
                boxGuess.classList.remove('hidden');
                inputLabel.innerText = myGroup.wordObj.theme;
                document.getElementById('btn-submit').innerText = "CONFIRMER R√âCEPTION";
            } else if (myPlayer.role === 'interceptor') {
                rTitle.innerText = "INTERCEPTEUR";
                rTitle.className = "text-2xl font-bold text-red-400 uppercase tracking-widest mb-1";
                rDesc.innerText = "Interceptez le code ennemi.";
                rIcon.innerText = "üï∂Ô∏è";
                document.getElementById('role-card').classList.add('border-red-500');
                boxSecret.classList.add('hidden');
                boxGuess.classList.remove('hidden');
                inputLabel.innerText = "???";
                document.getElementById('btn-submit').innerText = "CONFIRMER INTERCEPTION";
            }

            const feed = document.getElementById('game-feedback');
            const guessInput = document.getElementById('guess-input');
            const guessBtn = document.getElementById('btn-submit');

            if (myGroup.status !== 'active') {
                feed.classList.remove('hidden');
                guessInput.disabled = true;
                guessBtn.disabled = true;
                guessBtn.classList.add('opacity-50');
                if (myGroup.status === 'target_won') feed.innerHTML = `<span class="text-green-500 block text-xl">‚úÖ TRANSMISSION R√âUSSIE</span>`;
                else if (myGroup.status === 'interceptor_won') feed.innerHTML = `<span class="text-red-500 block text-xl">üö´ MESSAGE INTERCEPT√â</span>`;
                else if (myGroup.status === 'failed') feed.innerHTML = `<span class="text-gray-500 block text-xl">‚ùå ECHEC MISSION</span>`;
            } else {
                feed.classList.add('hidden');
                guessInput.disabled = false;
                guessBtn.disabled = false;
                guessBtn.classList.remove('opacity-50');
            }
        }

        function renderResultsView(round) {
            const container = document.getElementById('results-container');
            container.innerHTML = "";
            if (!round || !round.groups) return;
            round.groups.forEach(g => {
                let statusHTML = g.status === 'target_won' ? "<span class='text-green-500'>SUCC√àS</span>" : (g.status === 'interceptor_won' ? "<span class='text-red-500'>INTERCEPT√â</span>" : "<span class='text-gray-500'>ECHEC</span>");
                let infName = g.players.find(p => p.role === 'informant')?.name || "?";
                let tarNames = g.players.filter(p => p.role === 'target').map(p => p.name).join(', ');
                let intNames = g.players.filter(p => p.role === 'interceptor').map(p => p.name).join(', ');
                const card = `
                <div class="glass p-4 rounded-xl border border-gray-700 mb-4">
                    <div class="flex justify-between items-start mb-2 border-b border-gray-800 pb-2">
                        <span class="text-xs text-gray-500 font-bold tracking-widest">GROUPE ${g.id}</span>
                        <div class="font-bold tracking-widest">${statusHTML}</div>
                    </div>
                    <div class="mb-3 text-center">
                        <div class="text-[10px] text-gray-500 uppercase">CODE SECRET</div>
                        <div class="text-2xl font-bold text-white tracking-[0.2em]">${g.wordObj.word}</div>
                        <div class="text-[10px] text-gray-600 font-mono">${g.wordObj.theme}</div>
                    </div>
                    <div class="space-y-2 text-xs font-mono">
                        <div class="flex justify-between items-center bg-blue-900/10 p-1 px-2 rounded"><span class="text-blue-400">üì° INF:</span><span class="text-white">${infName}</span></div>
                        <div class="flex justify-between items-center bg-green-900/10 p-1 px-2 rounded"><span class="text-green-400">üéØ CIBLE:</span><span class="text-white">${tarNames}</span></div>
                        <div class="flex justify-between items-center bg-red-900/10 p-1 px-2 rounded"><span class="text-red-400">üï∂Ô∏è INT:</span><span class="text-white">${intNames}</span></div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        function renderPlayerList(players, adminId) {
            const list = document.getElementById('players-list');
            document.getElementById('player-count').innerText = players.length;
            list.innerHTML = '';
            players.forEach(p => {
                const isMe = p.id === currentUser.id, isAdmin = p.id === adminId;
                const pSafe = encodeURIComponent(JSON.stringify(p));
                let admHtml = (currentUser.isAdmin && !isMe) ? `<div class="flex gap-2 ml-2"><button onclick="renamePlayer('${pSafe}')" class="text-gray-500 hover:text-white">‚úé</button><button onclick="kickPlayer('${pSafe}')" class="text-red-800 hover:text-red-500 font-bold">‚úï</button></div>` : '';
                const html = `<div class="flex justify-between items-center p-2 rounded border-b border-gray-800 bg-black/40 hover:bg-white/5 transition-colors"><div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full ${isMe ? 'bg-neon-green shadow-[0_0_5px_#00ff41]' : 'bg-gray-600'}"></div><div class="flex flex-col"><span class="font-mono text-sm tracking-widest ${isMe ? 'text-neon-green font-bold' : 'text-gray-300'}">${p.name}</span>${isAdmin ? '<span class="text-[9px] text-yellow-600 font-bold uppercase tracking-widest">COMMANDER</span>' : ''}</div></div>${admHtml}</div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
            const adm = document.getElementById('admin-controls');
            if (currentUser.isAdmin) adm.classList.remove('hidden'); else adm.classList.add('hidden');

            const launchBtn = document.querySelector("button[onclick=\"updateGameState('playing')\"]");
            if (launchBtn) {
                launchBtn.setAttribute('onclick', 'startRound()');
                if (players.length < 3) launchBtn.classList.add('opacity-50', 'cursor-not-allowed'); else launchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function setupLobbyListener(code) {
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            lobbyUnsubscribe = onSnapshot(doc(db, "lobbies", code), (snap) => {
                if (!snap.exists()) { if (currentLobbyCode) { clearSession(); location.reload(); } return; }
                const data = snap.data();
                lobbyData = data;

                if (data.state === 'waiting') {
                    switchScreen('lobby');
                    renderPlayerList(data.players, data.adminId);
                } else if (data.state === 'playing') {
                    switchScreen('game');
                    renderGameView(data.round);
                } else if (data.state === 'finished') {
                    switchScreen('results');
                    renderResultsView(data.round);
                    if (currentUser.isAdmin) document.getElementById('admin-results-controls').classList.remove('hidden');
                    else document.getElementById('waiting-next-round').classList.remove('hidden');
                }

                const kicked = !data.players.find(p => p.id === currentUser.id);
                if (kicked && !currentUser.isAdmin) { clearSession(); alert("ACC√àS REFUS√â."); location.reload(); }

                const gameAdm = document.getElementById('admin-game-controls');
                if (currentUser.isAdmin && data.state === 'playing') gameAdm.classList.remove('hidden'); else gameAdm.classList.add('hidden');
            });
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        // --- GLOBAL EXPORTS ---
        window.leaveGame = async () => { if (currentLobbyCode && currentUser.id) { if (!currentUser.isAdmin) { if (!confirm("CONFIRMATION: VOULEZ-VOUS ABANDONNER LA MISSION ?")) return; try { const ref = doc(db, "lobbies", currentLobbyCode); const s = await getDoc(ref); if (s.exists()) { const p = s.data().players.filter(x => x.id !== currentUser.id); await updateDoc(ref, { players: p }); } clearSession(); location.reload(); } catch (e) { console.error(e); clearSession(); location.reload(); } } else { if (confirm("ATTENTION: L'ABANDON DETRUIT LE SYSTEME.")) deleteLobby(); } } };
        window.deleteLobby = async () => { if (confirm("CONFIRMER DESTRUCTION ?")) { await deleteDoc(doc(db, "lobbies", currentLobbyCode)); clearSession(); } };
        window.shareCode = () => { const u = window.location.origin + window.location.pathname + "?room=" + currentLobbyCode; navigator.clipboard.writeText(`MISSION: ${currentLobbyCode}\n${u}`).then(() => showToast("COPI√â", "success")); };
        window.kickPlayer = async (j) => { const p = JSON.parse(decodeURIComponent(j)); if (confirm(`EJECTER ${p.name}?`)) await updateDoc(doc(db, "lobbies", currentLobbyCode), { players: arrayRemove(p) }); };
        window.renamePlayer = async (j) => { const p = JSON.parse(decodeURIComponent(j)); const n = prompt("NOM:", p.name); if (n && n !== p.name) { const ref = doc(db, "lobbies", currentLobbyCode); const s = await getDoc(ref); const pls = s.data().players; const idx = pls.findIndex(x => x.id === p.id); if (idx !== -1) { pls[idx].name = n; await updateDoc(ref, { players: pls }); } } };

        window.createGame = createGame; window.joinGame = joinGame; window.startRound = startRound; window.stopRound = stopRound; window.startNewRound = startNewRound; window.submitGuess = submitGuess; window.updateGameState = updateGameState;

        window.addEventListener('load', () => { if (!restoreSession()) { const p = new URLSearchParams(window.location.search).get('room'); if (p) inputs.joinCode.value = p; } });

    </script>
</body>

</html>