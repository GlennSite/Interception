<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INTERCEPTION - CONFIDENTIAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Safe Area Variables for notch/home bar */
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #050505;
            background-image:
                linear-gradient(rgba(0, 255, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            color: #e0e0e0;
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height specifically for mobile browsers */
            overflow: hidden;
            padding-top: var(--sat);
            padding-bottom: var(--sab);
        }

        /* Vignette & Scanline */
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 50%, black 150%);
            pointer-events: none;
            z-index: 10;
        }

        .crt-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 5s linear infinite;
            z-index: 9;
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                top: -10%;
            }

            100% {
                top: 110%;
            }
        }

        /* Glass / Tech Panel */
        .glass {
            background: rgba(10, 20, 10, 0.7);
            border: 1px solid #333;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            position: relative;
        }

        .glass::before {
            content: "";
            position: absolute;
            top: -1px;
            left: -1px;
            width: 10px;
            height: 10px;
            border-top: 2px solid #555;
            border-left: 2px solid #555;
        }

        .glass::after {
            content: "";
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid #555;
            border-right: 2px solid #555;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }

        .text-neon-green {
            color: #00ff41;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }

        .border-neon-green {
            border-color: #00ff41;
        }

        .bg-neon-green {
            background-color: #00ff41;
        }

        .text-neon-red {
            color: #ff3333;
            text-shadow: 0 0 5px rgba(255, 51, 51, 0.5);
        }

        .glow {
            text-shadow: 0 0 10px currentColor;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4 relative">

    <div class="crt-line"></div>

    <div id="toast"
        class="fixed top-12 left-1/2 transform -translate-x-1/2 z-50 bg-black border border-red-500 text-red-500 px-6 py-3 shadow-[0_0_15px_rgba(255,0,0,0.5)] text-sm font-bold hidden transition-all duration-300 uppercase tracking-widest text-center w-max max-w-[90%]">
        Erreur
    </div>

    <!-- MENU SCREEN -->
    <div id="screen-menu" class="w-full max-w-md flex flex-col gap-6 fade-in z-20 overflow-y-auto no-scrollbar py-4">
        <h1 class="text-5xl font-bold text-center text-gray-200 tracking-[0.2em] mb-4 drop-shadow-lg mt-8">
            INTER<span class="text-neon-red">CEPTION</span>
        </h1>

        <div class="glass p-6 flex flex-col gap-4">
            <label class="text-xs text-neon-green font-bold uppercase tracking-widest mb-1">> IDENTIFIANT_AGENT</label>
            <input type="text" id="username" placeholder="NOM DE CODE..."
                class="w-full bg-black/50 border border-gray-600 text-white px-4 py-4 text-lg font-bold placeholder-gray-700 focus:bg-black transition-all font-mono">
        </div>

        <div class="glass p-6 flex flex-col gap-4 mt-2">
            <label class="text-xs text-neon-green font-bold uppercase tracking-widest mb-1">> ACCES_MISSION</label>
            <div class="flex gap-2">
                <input type="text" id="join-code" placeholder="CODE" maxlength="4"
                    class="w-2/3 bg-black/50 border border-gray-600 text-white px-4 py-4 text-lg text-center font-bold uppercase tracking-[0.2em] placeholder-gray-700 focus:bg-black transition-all font-mono">
                <button onclick="joinGame()"
                    class="w-1/3 bg-gray-800 hover:bg-gray-700 border border-gray-500 text-white font-bold active:scale-95 transition-all text-sm tracking-widest hover:border-neon-green hover:text-neon-green">
                    JOIN
                </button>
            </div>
        </div>

        <div class="relative flex py-2 items-center opacity-50">
            <div class="flex-grow border-t border-gray-800"></div>
            <span class="flex-shrink mx-4 text-gray-600 text-xs tracking-widest">OU</span>
            <div class="flex-grow border-t border-gray-800"></div>
        </div>

        <button onclick="createGame()"
            class="w-full bg-gradient-to-r from-gray-900 to-black hover:from-black hover:to-gray-900 border border-neon-red text-neon-red font-bold py-5 text-xl shadow-[0_0_10px_rgba(255,51,51,0.2)] active:scale-95 transition-all tracking-widest mb-8">
            INITIER_PROTOCOLE
        </button>
    </div>

    <!-- LOBBY SCREEN -->
    <div id="screen-lobby" class="w-full max-w-md h-full flex flex-col hidden z-20 relative pt-2">

        <!-- Top Bar -->
        <div class="flex justify-between items-end mb-4 pt-2 border-b border-gray-800 pb-2">
            <button onclick="leaveGame()"
                class="text-gray-500 hover:text-red-500 text-xs font-bold tracking-widest transition-colors p-2">
                < ABORT </button>
                    <div class="text-right">
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest">FrÃ©quence SÃ©curisÃ©e</div>
                        <div class="flex items-center justify-end gap-2">
                            <span id="lobby-code-display"
                                class="text-neon-green font-bold text-3xl tracking-[0.1em] select-all cursor-pointer hover:bg-green-900/30 px-2 rounded">????</span>
                        </div>
                    </div>
        </div>

        <!-- Status Box -->
        <div id="game-status-container"
            class="glass p-6 text-center mb-6 flex flex-col items-center justify-center min-h-[120px] border-l-4 border-l-gray-500 shrink-0">
            <div id="status-icon" class="text-3xl mb-2 opacity-80"></div>
            <h2 id="game-status-text" class="text-xl font-bold text-white uppercase tracking-widest">En attente...</h2>
            <p id="game-status-sub" class="text-gray-500 text-xs mt-1 font-mono">Awaiting admin command...</p>
        </div>

        <!-- Admin Controls -->
        <div id="admin-controls" class="hidden flex flex-col gap-3 mb-6 shrink-0">
            <!-- Injected via JS -->
        </div>

        <!-- Players List -->
        <div class="flex-1 glass flex flex-col overflow-hidden relative mb-4">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gray-700 to-transparent">
            </div>

            <h3
                class="p-4 text-xs font-bold text-gray-500 uppercase tracking-widest flex justify-between items-center border-b border-gray-800 shrink-0">
                <span>AGENTS ACTIFS</span>
                <span id="player-count" class="text-neon-green font-mono text-lg">0</span>
            </h3>

            <!-- Modified container to be more generic -->
            <div id="players-list" class="flex-1 overflow-y-auto no-scrollbar flex flex-col">
                <!-- Players or Game UI will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- DATASET ---
        const GAME_DATA = [
            { theme: "ANIMAUX", words: ["LION", "TIGRE", "ELEPHANT", "GIRAFE", "PINGOUIN", "AIGLE", "REQUIN", "CHIEN", "CHAT", "LOUP"] },
            { theme: "CUISINE", words: ["PIZZA", "SUSHI", "BURGER", "PATES", "SALADE", "GATEAU", "OEUF", "FROMAGE", "CHOCOLAT", "PAIN"] },
            { theme: "VOYAGE", words: ["AVION", "TRAIN", "BATEAU", "PLAGE", "MONTAGNE", "HOTEL", "VALISE", "PASSEPORT", "CARTE", "GUIDE"] },
            { theme: "MAISON", words: ["LIT", "TABLE", "CHAISE", "CUISINE", "SALON", "DOUCHE", "JARDIN", "GARAGE", "FENETRE", "PORTE"] },
            { theme: "SPORT", words: ["FOOTBALL", "TENNIS", "BASKET", "NATATION", "VELO", "COURSE", "SKI", "JUDO", "BOXE", "GOLF"] },
            { theme: "METIER", words: ["DOCTEUR", "POLICIER", "POMPIER", "PROFESSEUR", "AVOCAT", "CUISINIER", "AGRICULTEUR", "PILOTE", "ACTEUR", "CHANTEUR"] },
            { theme: "CORPS HUMAIN", words: ["MAIN", "PIED", "TETE", "OEIL", "NEZ", "BOUCHE", "OREILLE", "COEUR", "JAMBE", "BRAS"] },
            { theme: "ECOLE", words: ["STYLO", "CAHIER", "LIVRE", "GOMME", "CRAYON", "TABLEAU", "CARTABLE", "TROUSSE", "DEVOIRS", "RECREATION"] },
            { theme: "TECHNOLOGIE", words: ["ORDINATEUR", "TELEPHONE", "TABLETTE", "INTERNET", "ROBOT", "CAMERA", "ECRAN", "CLAVIER", "SOURIS", "WIFI"] },
            { theme: "CINEMA", words: ["FILM", "ACTEUR", "POPCORN", "SALLE", "ECRAN", "HEROS", "ACTION", "COMEDIE", "DRAME", "HORREUR"] }
        ];

        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCiarvgeK3eS8S1SxBj3SMW0L4AzsBkig8",
            authDomain: "interception-e9a6d.firebaseapp.com",
            projectId: "interception-e9a6d",
            storageBucket: "interception-e9a6d.firebasestorage.app",
            messagingSenderId: "533782599002",
            appId: "1:533782599002:web:8ec56b56a05bc0f24f4f63",
            measurementId: "G-38QTT8BH8G"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Ã‰TAT GLOBAL ---
        let currentUser = { id: null, name: null, isAdmin: false };
        let currentLobbyCode = null;
        let lobbyUnsubscribe = null;

        // --- DOM ELEMENTS ---
        const screens = {
            menu: document.getElementById('screen-menu'),
            lobby: document.getElementById('screen-lobby')
        };
        const inputs = {
            username: document.getElementById('username'),
            joinCode: document.getElementById('join-code')
        };

        // --- HELPERS PERSISTENCE ---
        function saveSession(user, code) {
            localStorage.setItem('interception_session', JSON.stringify({
                user: user,
                code: code,
                timestamp: Date.now()
            }));
        }

        function clearSession() {
            localStorage.removeItem('interception_session');
        }

        function restoreSession() {
            const raw = localStorage.getItem('interception_session');
            if (raw) {
                try {
                    const session = JSON.parse(raw);
                    if (session.user && session.code) {
                        currentUser = session.user;
                        currentLobbyCode = session.code;
                        inputs.username.value = session.user.name;
                        inputs.joinCode.value = session.code;
                        setupLobbyListener(session.code);
                        switchScreen('lobby');
                        document.getElementById('lobby-code-display').innerText = session.code;
                        return true;
                    }
                } catch (e) {
                    console.error("Erreur restore session", e);
                    clearSession();
                }
            }
            return false;
        }

        // --- UTILITAIRES ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function generateLobbyCode() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ";
            let result = "";
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }
        function fmtTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${sec < 10 ? '0' + sec : sec}`;
        }
        function fmtTimeShort(ts) {
            const d = new Date(ts);
            return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
        }
        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = `fixed top-12 left-1/2 transform -translate-x-1/2 z-50 bg-black border ${type === 'success' ? 'border-green-500 text-green-500' : 'border-red-500 text-red-500'} px-6 py-3 shadow-[0_0_15px_rgba(0,0,0,0.5)] text-sm font-bold transition-all duration-300 uppercase tracking-widest w-max max-w-[90%] text-center`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        function switchScreen(screenName) {
            screens.menu.classList.add('hidden');
            screens.lobby.classList.add('hidden');
            screens[screenName].classList.remove('hidden');
            screens[screenName].classList.add('fade-in');
        }

        // --- LOGIQUE METIER ---

        // 1. CrÃ©er une partie
        window.createGame = async () => {
            const username = inputs.username.value.trim();
            if (!username) return showToast("IDENTITE REQUISE");

            const code = generateLobbyCode();
            const userId = generateId();
            currentUser = { id: userId, name: username, isAdmin: true };
            currentLobbyCode = code;

            try {
                await setDoc(doc(db, "lobbies", code), {
                    adminId: userId,
                    createdAt: Date.now(),
                    state: "waiting", // waiting, playing, finished
                    round: null, // stockera les infos de la manche
                    scores: { [userId]: 0 },
                    players: [{ id: userId, name: username, joinedAt: Date.now() }]
                });

                saveSession(currentUser, currentLobbyCode);
                setupLobbyListener(code);
                switchScreen('lobby');
                document.getElementById('lobby-code-display').innerText = code;
            } catch (e) { console.error(e); showToast("ECHEC CREATION SYSTEME"); }
        };

        // 2. Rejoindre une partie
        window.joinGame = async () => {
            const username = inputs.username.value.trim();
            const code = inputs.joinCode.value.trim().toUpperCase();

            if (!username) return showToast("IDENTITE REQUISE");
            if (code.length !== 4) return showToast("CODE PROTOCOLE INVALIDE");

            const userId = generateId();
            currentUser = { id: userId, name: username, isAdmin: false };
            currentLobbyCode = code;

            try {
                const lobbyRef = doc(db, "lobbies", code);
                const lobbySnap = await getDoc(lobbyRef);

                if (!lobbySnap.exists()) return showToast("FREQUENCE INCONNUE");

                await updateDoc(lobbyRef, {
                    players: arrayUnion({ id: userId, name: username, joinedAt: Date.now() }),
                    [`scores.${userId}`]: 0 // Init score
                });

                saveSession(currentUser, currentLobbyCode);
                setupLobbyListener(code);
                switchScreen('lobby');
                document.getElementById('lobby-code-display').innerText = code;
            } catch (e) { console.error(e); showToast("CONNEXION IMPOSSIBLE"); }
        };

        // 3. Quitter / Supprimer
        window.leaveGame = async () => {
            if (currentLobbyCode && currentUser.id) {
                if (!currentUser.isAdmin) {
                    if (!confirm("CONFIRMATION: VOULEZ-VOUS ABANDONNER LA MISSION ?")) return;
                    try {
                        const lobbyRef = doc(db, "lobbies", currentLobbyCode);
                        const snap = await getDoc(lobbyRef);
                        if (snap.exists()) {
                            const players = snap.data().players;
                            const newPlayers = players.filter(p => p.id !== currentUser.id);
                            await updateDoc(lobbyRef, { players: newPlayers });
                        }
                        clearSession(); location.reload();
                    } catch (e) { clearSession(); location.reload(); }
                } else {
                    if (confirm("ATTENTION: L'ABANDON DETRUIT LE SYSTEME. CONFIRMER ?")) deleteLobby();
                }
            }
        };

        window.deleteLobby = async () => {
            if (!currentUser.isAdmin) return;
            if (!confirm("CONFIRMATION REQUISE: CECI EFFACERA TOUTE TRACE DE LA MISSION.")) return;
            try { await deleteDoc(doc(db, "lobbies", currentLobbyCode)); clearSession(); } catch (e) { showToast("ERREUR SUPPRESSION"); }
        };

        // --- GAMEPLAY: LANCER UNE MANCHE ---
        window.startRound = async () => {
            if (!currentUser.isAdmin) return;

            const lobbyRef = doc(db, "lobbies", currentLobbyCode);
            const snap = await getDoc(lobbyRef);
            const players = snap.data().players;

            if (players.length < 3) return showToast("MINIMUM 3 AGENTS REQUIS");

            // 1. Choix du mot
            const dataset = GAME_DATA[Math.floor(Math.random() * GAME_DATA.length)];
            const word = dataset.words[Math.floor(Math.random() * dataset.words.length)];

            // 2. Attribution des rÃ´les
            const nbInterceptors = Math.max(1, Math.floor((players.length - 1) / 3));

            let shuffled = [...players].sort(() => 0.5 - Math.random());
            const informer = shuffled.pop();
            const interceptors = [];
            for (let i = 0; i < nbInterceptors; i++) interceptors.push(shuffled.pop());
            const targets = shuffled; // Le reste

            const roles = {};
            roles[informer.id] = 'INFORMER';
            interceptors.forEach(p => roles[p.id] = 'INTERCEPTOR');
            targets.forEach(p => roles[p.id] = 'TARGET');

            // 3. Mise Ã  jour DB
            await updateDoc(lobbyRef, {
                state: 'playing',
                round: {
                    theme: dataset.theme,
                    word: word.toUpperCase(),
                    roles: roles,
                    startTime: Date.now(),
                    duration: 120, // 2 minutes
                    guesses: [],
                    result: null
                }
            });
        };

        window.submitGuess = async () => {
            const input = document.getElementById('guess-input');
            const guess = input.value.trim().toUpperCase();
            if (!guess) return;

            const lobbyRef = doc(db, "lobbies", currentLobbyCode);
            await updateDoc(lobbyRef, {
                "round.guesses": arrayUnion({
                    playerId: currentUser.id,
                    word: guess,
                    timestamp: Date.now(),
                    name: currentUser.name
                })
            });
            input.value = "";
            showToast("HYPOTHÃˆSE TRANSMISE", "success");
        };

        // --- ECOUTEUR & UI ---
        function setupLobbyListener(code) {
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            lobbyUnsubscribe = onSnapshot(doc(db, "lobbies", code), (docSnap) => {
                if (!docSnap.exists()) { clearSession(); alert("CANAL OFF."); location.reload(); return; }
                const data = docSnap.data();

                // Kick check
                if (!data.players.find(p => p.id === currentUser.id) && !currentUser.isAdmin) {
                    clearSession(); alert("EXCLU."); location.reload(); return;
                }

                updateGameUI(data);
            });
        }

        function updateGameUI(data) {
            const state = data.state;
            const container = document.getElementById('game-status-container');
            const adminPanel = document.getElementById('admin-controls');

            // 1. GESTION DU TIMER
            if (state === 'playing' && data.round && !data.round.result) {
                const elapsed = Math.floor((Date.now() - data.round.startTime) / 1000);
                const remaining = Math.max(0, data.round.duration - elapsed);

                // Fin auto par admin
                if (remaining === 0 && currentUser.isAdmin) endRound(data, 'TIME_UP');

                // VÃ©rification Victoire
                if (currentUser.isAdmin) {
                    const match = data.round.guesses.find(g => g.word === data.round.word);
                    if (match) {
                        const winnerRole = data.round.roles[match.playerId];
                        if (winnerRole === 'INTERCEPTOR') endRound(data, 'INTERCEPTOR_WIN', match);
                        else if (winnerRole === 'TARGET') endRound(data, 'SPY_WIN', match);
                        else if (winnerRole === 'INFORMER') { } // Informer peut pas deviner son mot
                    }
                }

                document.getElementById('game-status-text').innerText = fmtTime(remaining);
                document.getElementById('status-icon').innerText = remaining < 10 ? "ðŸš¨" : "â±";
            } else if (state === 'waiting') {
                document.getElementById('game-status-text').innerText = "EN ATTENTE";
                document.getElementById('status-icon').innerText = "â³";
            } else if (state === 'finished') {
                document.getElementById('game-status-text').innerText = "MISSION TERMINÃ‰E";
                document.getElementById('status-icon').innerText = "ðŸ";
            }

            // 2. INTERFACE
            if (state === 'playing') renderInGameInterface(data);
            else renderLobbyInterface(data);

            // 3. ADMIN
            if (currentUser.isAdmin) {
                adminPanel.classList.remove('hidden');
                if (state === 'playing') {
                    adminPanel.innerHTML = `<button onclick="stopRound()" class="w-full bg-red-900/50 border border-red-500 text-red-500 p-2 text-xs font-bold uppercase">ARRÃŠT D'URGENCE</button>`;
                } else {
                    adminPanel.innerHTML = `
                        <div class="grid grid-cols-2 gap-2">
                             <button onclick="startRound()" class="col-span-2 bg-neon-green text-black border border-neon-green p-3 font-bold text-sm uppercase tracking-widest shadow-[0_0_10px_rgba(0,255,0,0.4)]">LANCER MISSION</button>
                             <button onclick="shareCode()" class="bg-gray-800 border border-gray-600 text-gray-300 p-2 text-xs uppercase">INVITER</button>
                             <button onclick="deleteLobby()" class="bg-black border border-red-900 text-red-700 p-2 text-xs uppercase">DÃ‰TRUIRE</button>
                        </div>
                     `;
                }
            } else {
                adminPanel.classList.add('hidden');
            }
        }

        function renderLobbyInterface(data) {
            const list = document.getElementById('players-list');
            const sub = document.getElementById('game-status-sub');

            // Clean classes for generic list
            list.className = "flex-1 overflow-y-auto no-scrollbar space-y-2 p-4";

            if (data.state === 'finished' && data.round && data.round.result) {
                let msg = data.round.result === 'INTERCEPTOR_WIN' ? "INTERCEPTION RÃ‰USSIE !" :
                    data.round.result === 'SPIES_WIN' ? "TRANSMISSION RÃ‰USSIE !" :
                        "ECHEC DE LA MISSION";
                sub.innerHTML = `<span class="text-neon-red font-bold">${msg}</span><br>Le mot Ã©tait: ${data.round.word}`;
            } else {
                sub.innerText = "En attente du QG...";
            }

            document.getElementById('player-count').innerText = data.players.length;
            list.innerHTML = '';
            data.players.forEach(p => {
                const isMe = p.id === currentUser.id;
                const score = (data.scores && data.scores[p.id]) || 0;

                // Allow admin to kick in lobby
                let adminActions = '';
                if (currentUser.isAdmin && !isMe) {
                    const pSafe = encodeURIComponent(JSON.stringify(p));
                    adminActions = `<button onclick="kickPlayer('${pSafe}')" class="text-red-800 hover:text-red-500 font-bold ml-2">âœ•</button>`;
                }

                list.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center p-2 border-b border-gray-800 bg-black/40">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-sm ${isMe ? 'text-neon-green' : 'text-gray-300'}">${p.name}</span>
                            ${data.adminId === p.id ? '<span class="text-[10px] text-yellow-600">CMD</span>' : ''}
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-white text-xs px-2 py-1 bg-gray-800 rounded">${score} pts</span>
                            ${adminActions}
                        </div>
                    </div>
                `);
            });
        }

        function renderInGameInterface(data) {
            const list = document.getElementById('players-list');
            const sub = document.getElementById('game-status-sub');

            // Layout container mode
            list.className = "flex-1 overflow-hidden flex flex-col";

            const myRole = data.round.roles[currentUser.id];
            let roleName = "", infoText = "";
            let canGuess = false;

            if (myRole === 'INFORMER') {
                roleName = "INFORMATEUR";
                infoText = `THEME: <span class="text-white">${data.round.theme}</span><br>MOT CODE: <span class="text-neon-green text-xl glow">${data.round.word}</span>`;
            } else if (myRole === 'TARGET') {
                roleName = "AGENT CIBLE";
                infoText = `THEME: <span class="text-white">${data.round.theme}</span><br>MOT CODE: <span class="text-red-500">???</span>`;
                canGuess = true;
            } else {
                roleName = "INTERCEPTEUR";
                infoText = `THEME: <span class="text-red-500">INCONNU</span><br>MOT CODE: <span class="text-red-500">???</span>`;
                canGuess = true;
            }

            sub.innerHTML = `<span class="text-xs text-gray-500 tracking-widest">VOTRE RÃ”LE</span><br><span class="text-lg font-bold text-white">${roleName}</span>`;

            list.innerHTML = `
                <div class="p-4 flex flex-col gap-4 h-full">
                    <div class="glass p-4 text-center border-l-2 border-neon-green">
                        ${infoText}
                    </div>
                    
                    <div id="guess-feed" class="flex-1 overflow-y-auto min-h-[100px] text-xs font-mono space-y-1 p-2 bg-black/30 rounded border border-gray-800">
                        ${data.round.guesses.map(g => `
                            <div><span class="text-gray-500">[${fmtTimeShort(g.timestamp)}]</span> <span class="text-gray-300">${g.name}:</span> ${myRole === 'INFORMER' || g.word === data.round.word || myRole === 'INTERCEPTOR' ? g.word : '*****'}</div>
                        `).join('')}
                    </div>

                    ${canGuess ? `
                    <div class="mt-auto">
                        <div class="flex gap-2">
                            <input type="text" id="guess-input" placeholder="SAISIR VOTRE HYPOTHÃˆSE..." class="w-full bg-black border border-gray-600 p-3 text-white font-bold uppercase focus:border-neon-green outline-none">
                            <button onclick="submitGuess()" class="bg-gray-800 border border-gray-600 text-white px-4 hover:bg-gray-700">></button>
                        </div>
                    </div>
                    ` : '<div class="mt-auto text-center text-xs text-gray-500">TRANSMETTEZ LE CODE ORALEMENT. DO NOT TYPE.</div>'}
                </div>
            `;
        }

        // --- FIN DE MANCHE ---
        window.stopRound = async () => {
            const lobbyRef = doc(db, "lobbies", currentLobbyCode);
            await updateDoc(lobbyRef, { state: 'finished' });
        };

        window.endRound = async (data, reason, winningGuess = null) => {
            const lobbyRef = doc(db, "lobbies", currentLobbyCode);
            let result = 'FAIL';
            let scoresUpdate = { ...data.scores };

            if (reason === 'INTERCEPTOR_WIN' && winningGuess) {
                result = 'INTERCEPTOR_WIN';
                const winnerId = winningGuess.playerId;
                scoresUpdate[winnerId] = (scoresUpdate[winnerId] || 0) + 3;
            } else if (reason === 'SPY_WIN' && winningGuess) {
                result = 'SPIES_WIN';
                const winnerId = winningGuess.playerId;
                let informerId = null;
                for (let [pid, role] of Object.entries(data.round.roles)) {
                    if (role === 'INFORMER') informerId = pid;
                }
                scoresUpdate[winnerId] = (scoresUpdate[winnerId] || 0) + 2;
                if (informerId) scoresUpdate[informerId] = (scoresUpdate[informerId] || 0) + 2;
            }

            await updateDoc(lobbyRef, {
                state: 'finished',
                scores: scoresUpdate,
                "round.result": result
            });
        }

        // --- 6. Gestion Joueurs ---
        window.kickPlayer = async (playerJson) => {
            const player = JSON.parse(decodeURIComponent(playerJson));
            if (confirm(`EXPULSER L'AGENT ${player.name} ?`)) {
                await updateDoc(doc(db, "lobbies", currentLobbyCode), {
                    players: arrayRemove(player)
                });
            }
        };

        window.renamePlayer = async (playerJson) => {
            // Deprecated/Simplified for this mode
        };
    </script>
</body>

</html>